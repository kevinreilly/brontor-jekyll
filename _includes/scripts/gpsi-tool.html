<script>
  // Specify your actual API key here:
  var API_KEY = 'AIzaSyClNfdZIs8di1m0zztluWwmdbAewfQJpqQ';

  // Specify the URL you want PageSpeed results for here:
  //var URL_TO_GET_RESULTS_FOR = 'http://kevinreilly.io';


  var API_URL = 'https://www.googleapis.com/pagespeedonline/v2/runPagespeed?';
  var CHART_API_URL = 'https://chart.apis.google.com/chart?';

  // Object that will hold the callbacks that process results from the
  // PageSpeed Insights API.
  var callbacks = {}

  // Invokes the PageSpeed Insights API. The response will contain
  // JavaScript that invokes our callback with the PageSpeed results.
  function runPagespeed(url) {
    var s = document.createElement('script');
    s.type = 'text/javascript';
    s.async = true;
    var query = [
      'url=' + url,
      'callback=runPagespeedCallbacks',
      'key=' + API_KEY,
    ].join('&');
    s.src = API_URL + query;
    document.head.insertBefore(s, null);
  }

  // Our JSONP callback. Checks for errors, then invokes our callback handlers.
  function runPagespeedCallbacks(result) {
    if (result.error) {
      var errors = result.error.errors;
      for (var i = 0, len = errors.length; i < len; ++i) {
        if (errors[i].reason == 'badRequest' && API_KEY == 'yourAPIKey') {
          alert('Please specify your Google API key in the API_KEY variable.');
        } else {
          // NOTE: your real production app should use a better
          // mechanism than alert() to communicate the error to the user.
          alert(errors[i].message);
        }
      }
      return;
    }
    
    // Dispatch to each function on the callbacks object.
    for (var fn in callbacks) {
      var f = callbacks[fn];
      if (typeof f == 'function') {
        callbacks[fn](result);
      }
    }
  }

  // Invoke the callback that fetches results. Async here so we're sure
  // to discover any callbacks registered below, but this can be
  // synchronous in your code.
  //setTimeout(runPagespeed(URL_TO_GET_RESULTS_FOR), 0);


  callbacks.displayPageSpeedScore = function(result) {
    var score = result.ruleGroups.SPEED.score;
    document.getElementsByClassName('pagespeed-results')[0].innerHTML = 'Score: '+ score +'/100';
  };


  callbacks.displayTopPageSpeedSuggestions = function(result) {
    var results = [];
    var ruleResults = result.formattedResults.ruleResults;
    for (var i in ruleResults) {
      var ruleResult = ruleResults[i];
      // Don't display lower-impact suggestions.
      if (ruleResult.ruleImpact < 0.1) continue;
      results.push({name: ruleResult.localizedRuleName,
                    impact: ruleResult.ruleImpact});
    }
    results.sort(sortByImpact);
    var ul = document.createElement('div');
    for (var i = 0, len = results.length; i < len; ++i) {
      var r = document.createElement('div');
      r.className += 'alert alert-danger';
      r.innerHTML = results[i].name;
      ul.insertBefore(r, null);
    }
    if (ul.hasChildNodes()) {
      document.getElementsByClassName('pagespeed-results')[0].append(ul);
    } else {
      var div = document.createElement('div');
      div.className += 'alert alert-success';
      div.innerHTML = 'No high impact suggestions. Good job!';
      document.getElementsByClassName('pagespeed-results')[0].append(div);
    }
    var alerts = $('.pagespeed-results').find('.alert');
    for(var i = 0; i < alerts.length; i++){
      $(alerts[i]).slideDown();
    }
  };
  function sortByImpact(a, b) { return b.impact - a.impact; }

  $('.pagespeed-form').on('submit', function(e){
    e.preventDefault();
    var height = $(this).parent().height();
    $(this).parent().css({'minHeight':height});

    $(this).fadeOut();
    
    var test_url = $(this).find('.test_url').val();
    if(!test_url.includes('http')){
      test_url = 'http://'+ test_url;
    }
    runPagespeed(test_url);
  });
</script>